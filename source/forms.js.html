<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Mozilla Labs : TogetherJS
    </title>
    <meta name="viewport" content="width=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="description" content="Real time collaboration features for your website or app.">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../images/fav-icon.ico">

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/parallax.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/scrollTo.js"></script>
    <script src="../js/scrollspy.js"></script>
    <script src="../js/waypoints.min.js"></script>
    <script src="../js/how-animations.js"></script>
    <script src="../togetherjs.js"></script>

    <!-- retina library -->
    <script src="../js/retina.js"></script>

    <script src="//mozorg.cdn.mozilla.net/tabzilla/tabzilla.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35433268-28']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/jumbotron.css" rel="stylesheet">
    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/grid.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="//mozorg.cdn.mozilla.net/media/css/tabzilla-min.css" rel="stylesheet" />

    
  <link rel="stylesheet" href="../css/docco.css">
  <script src="../js/source-code.js"></script>


    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
      </script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">

  </head>
  <body >
    <div class="navbar navbar-inverse navbar-fixed-top main-header" id="main-navbar">

      <!-- Tabzilla -->
      <a href="https://www.mozilla.org/" id="tabzilla">mozilla</a>

      <!-- start container -->
      <div class="container navbox">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand main-logo scrollnav" href=".././"></a>
          <a class="navbar-brand masthead-title" href=".././">TogetherJS</a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right main-nav">
            <li><a href=".././"  >Overview</a></li>
            <li><a href=".././docs/"  >Documentation</a></li>
            <li><a href="https://github.com/mozilla/togetherjs" target="_blank">Github</a></li>
            <li><a href="mailto:togetherjs@mozilla.com">Contact</a></li>
          </ul>
        </div><!--/.navbar-collapse -->

      </div>
    </div>


    

<div class="container">

    <section class="row" id="sourcecode">
      <div class="col-md-3" id="source-toc">
        <div class="panel" role="complementary" data-spy="affix" data-offset-top="200" id="sidenav">
          <div class="panel-heading">Source Code</div>
          <ul class="nav" id="sectionmenu">
            
              <li><a href="analytics.js.html">analytics</a></li>
            
              <li><a href="channels.js.html">channels</a></li>
            
              <li><a href="chat.js.html">chat</a></li>
            
              <li><a href="cursor.js.html">cursor</a></li>
            
              <li><a href="elementFinder.js.html">elementFinder</a></li>
            
              <li><a href="eventMaker.js.html">eventMaker</a></li>
            
              <li><a href="forms.js.html">forms</a></li>
            
              <li><a href="jqueryPlugins.js.html">jqueryPlugins</a></li>
            
              <li><a href="linkify.js.html">linkify</a></li>
            
              <li><a href="ot.js.html">ot</a></li>
            
              <li><a href="peers.js.html">peers</a></li>
            
              <li><a href="playback.js.html">playback</a></li>
            
              <li><a href="randomutil.js.html">randomutil</a></li>
            
              <li><a href="recorder.js.html">recorder</a></li>
            
              <li><a href="session.js.html">session</a></li>
            
              <li><a href="startup.js.html">startup</a></li>
            
              <li><a href="storage.js.html">storage</a></li>
            
              <li><a href="templates.js.html">templates</a></li>
            
              <li><a href="templating.js.html">templating</a></li>
            
              <li><a href="togetherjs.js.html">togetherjs</a></li>
            
              <li><a href="ui.js.html">ui</a></li>
            
              <li><a href="util.js.html">util</a></li>
            
              <li><a href="videos.js.html">videos</a></li>
            
              <li><a href="visibilityApi.js.html">visibilityApi</a></li>
            
              <li><a href="walkthrough.js.html">walkthrough</a></li>
            
              <li><a href="webrtc.js.html">webrtc</a></li>
            
              <li><a href="who.js.html">who</a></li>
            
              <li><a href="windowing.js.html">windowing</a></li>
            
          </ul>
        </div>
      </div>

      <div class="col-md-9" id="source-content">
        <h1>forms.js</h1>
        
          <h4><p>Handles synchronization of forms, including CodeMirror and ACE support.  Implements a portion of OT.</p>
</h4>
        

        <div class="small"><a href="https://github.com/mozilla/togetherjs/blob/develop/togetherjs/forms.js">See this file on Github</a></div>

        <ul class="sections">
          
            <li id="section-0">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-0">&#182;</a>
                </div>
                
              </div>
              
                <div class="content"><div class='highlight'><pre><span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define([<span class="string">"jquery"</span>, <span class="string">"util"</span>, <span class="string">"session"</span>, <span class="string">"elementFinder"</span>, <span class="string">"eventMaker"</span>, <span class="string">"templating"</span>, <span class="string">"ot"</span>], <span class="function"><span class="keyword">function</span> <span class="params">($, util, session, elementFinder, eventMaker, templating, ot)</span> {</span>
  <span class="keyword">var</span> forms = util.Module(<span class="string">"forms"</span>);
  <span class="keyword">var</span> assert = util.assert;</pre></div></div>
              
            </li>
          
            <li id="section-1">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>This is how much larger the focus element is than the element it surrounds
(this is padding on each side)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> FOCUS_BUFFER = <span class="number">5</span>;

  <span class="keyword">var</span> inRemoteUpdate = <span class="literal">false</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">maybeChange</span><span class="params">(event)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-2">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
                </div>
                <p>Called when we get an event that may or may not indicate a real change
(like keyup in a textarea)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> tag = event.target.tagName;
    <span class="keyword">if</span> (tag == <span class="string">"TEXTAREA"</span> || tag == <span class="string">"INPUT"</span>) {
      change(event);
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">(event)</span> {</span>
    <span class="keyword">if</span> (inRemoteUpdate) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (elementFinder.ignoreElement(event.target) || elementTracked(event.target)) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> el = $(event.target);
    <span class="keyword">var</span> location = elementFinder.elementLocation(el);
    <span class="keyword">var</span> value = getValue(el);
    <span class="keyword">var</span> msg = {
      type: <span class="string">"form-update"</span>,
      element: location
    };
    <span class="keyword">if</span> (isText(el)) {
      <span class="keyword">var</span> history = el.data(<span class="string">"togetherjsHistory"</span>);
      <span class="keyword">if</span> (history.current == value) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (history) {
        <span class="keyword">var</span> delta = ot.TextReplace.fromChange(history.current, value);
        assert(delta);
        history.add(delta);
        maybeSendUpdate(msg.element, history);
        <span class="keyword">return</span>;
      } <span class="keyword">else</span> {
        msg.value = value;
        msg.basis = <span class="number">1</span>;
        el.data(<span class="string">"togetherjsHistory"</span>, ot.SimpleHistory(session.clientId, value, <span class="number">1</span>));
      }
    } <span class="keyword">else</span> {
      msg.value = value;
    }
    session.send(msg);
  }

  <span class="function"><span class="keyword">function</span> <span class="title">isCheckable</span><span class="params">(el)</span> {</span>
    el = $(el);
    <span class="keyword">var</span> type = (el.prop(<span class="string">"type"</span>) || <span class="string">"text"</span>).toLowerCase();
    <span class="keyword">if</span> (el.prop(<span class="string">"tagName"</span>) == <span class="string">"INPUT"</span> &amp;&amp; [<span class="string">"radio"</span>, <span class="string">"checkbox"</span>].indexOf(type) != -<span class="number">1</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="keyword">var</span> editTrackers = {};
  <span class="keyword">var</span> liveTrackers = [];

  TogetherJS.addTracker = <span class="function"><span class="keyword">function</span> <span class="params">(TrackerClass, skipSetInit)</span> {</span>
    assert(<span class="keyword">typeof</span> TrackerClass === <span class="string">"function"</span>, <span class="string">"You must pass in a class"</span>);
    assert(<span class="keyword">typeof</span> TrackerClass.prototype.trackerName === <span class="string">"string"</span>,
           <span class="string">"Needs a .prototype.trackerName string"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-3">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>Test for required instance methods.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="string">"destroy update init makeInit tracked"</span>.split(<span class="regexp">/ /</span>).forEach(<span class="keyword">function</span>(m) {
      assert(<span class="keyword">typeof</span> TrackerClass.prototype[m] === <span class="string">"function"</span>,
             <span class="string">"Missing required tracker method: "</span>+m);
    });</pre></div></div>
              
            </li>
          
            <li id="section-4">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>Test for required class methods.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="string">"scan tracked"</span>.split(<span class="regexp">/ /</span>).forEach(<span class="keyword">function</span>(m) {
      assert(<span class="keyword">typeof</span> TrackerClass[m] === <span class="string">"function"</span>,
             <span class="string">"Missing required tracker class method: "</span>+m);
    });
    editTrackers[TrackerClass.prototype.trackerName] = TrackerClass;
    <span class="keyword">if</span> (!skipSetInit) {
      setInit();
    }
  };

  <span class="keyword">var</span> AceEditor = util.Class({

    trackerName: <span class="string">"AceEditor"</span>,

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>.element = $(el);
      assert(<span class="keyword">this</span>.element.hasClass(<span class="string">"ace_editor"</span>));
      <span class="keyword">this</span>._change = <span class="keyword">this</span>._change.bind(<span class="keyword">this</span>);
      <span class="keyword">this</span>._editor().document.on(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    tracked: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>] === el;
    },

    destroy: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>._editor().document.removeListener(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    update: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">this</span>._editor().document.getDocument().applyDeltas([msg.delta]);
    },

    init: <span class="function"><span class="keyword">function</span> <span class="params">(update, msg)</span> {</span>
      <span class="keyword">this</span>._editor().document.setValue(update.value);
    },

    makeInit: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> {
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        tracker: <span class="keyword">this</span>.trackerName,
        value: <span class="keyword">this</span>._editor().document.getValue()
      };
    },

    _editor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>].env;
    },

    _change: <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-5">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
                </div>
                <p>FIXME: I should have an internal .send() function that automatically
asserts !inRemoteUpdate, among other things</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (inRemoteUpdate) {
        <span class="keyword">return</span>;
      }</pre></div></div>
              
            </li>
          
            <li id="section-6">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>FIXME: I want to use a more normalized version of replace instead of
ACE&#39;s native delta</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      session.send({
        type: <span class="string">"form-update"</span>,
        tracker: <span class="keyword">this</span>.trackerName,
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        delta: JSON.parse(JSON.stringify(e.data))
      });
    }
  });

  AceEditor.scan = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> $(<span class="string">".ace_editor"</span>);
  };

  AceEditor.tracked = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    <span class="keyword">return</span> !! $(el).closest(<span class="string">".ace_editor"</span>).length;
  };

  TogetherJS.addTracker(AceEditor, <span class="literal">true</span> <span class="comment">/* skip setInit */</span>);

  <span class="keyword">var</span> CodeMirrorEditor = util.Class({
    trackerName: <span class="string">"CodeMirrorEditor"</span>,

    constructor: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>.element = $(el);
      assert(<span class="keyword">this</span>.element[<span class="number">0</span>].CodeMirror);
      <span class="keyword">this</span>._change = <span class="keyword">this</span>._change.bind(<span class="keyword">this</span>);
      <span class="keyword">this</span>._editor().on(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    tracked: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>] === el;
    },

    destroy: <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
      <span class="keyword">this</span>._editor().off(<span class="string">"change"</span>, <span class="keyword">this</span>._change);
    },

    update: <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">this</span>._editor().replaceRange(
        msg.change.text,
        msg.change.from,
        msg.change.to);
    },

    init: <span class="function"><span class="keyword">function</span> <span class="params">(update, msg)</span> {</span>
      <span class="keyword">this</span>._editor().setValue(update.value);
    },

    makeInit: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> {
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        tracker: <span class="keyword">this</span>.trackerName,
        value: <span class="keyword">this</span>._editor().getValue()
      };
    },

    _change: <span class="function"><span class="keyword">function</span> <span class="params">(editor, change)</span> {</span>
      <span class="keyword">if</span> (inRemoteUpdate) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">delete</span> change.origin;
      <span class="keyword">var</span> next = change.next;
      <span class="keyword">delete</span> change.next;
      session.send({
        type: <span class="string">"form-update"</span>,
        tracker: <span class="keyword">this</span>.trackerName,
        element: elementFinder.elementLocation(<span class="keyword">this</span>.element),
        change: change
      });
      <span class="keyword">if</span> (next) {
        <span class="keyword">this</span>._change(editor, next);
      }
    },

    _editor: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.element[<span class="number">0</span>].CodeMirror;
    }
  });

  CodeMirrorEditor.scan = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">var</span> result = [];
    <span class="keyword">var</span> els = document.body.getElementsByTagName(<span class="string">"*"</span>);
    <span class="keyword">var</span> _len = els.length;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;_len; i++) {
      <span class="keyword">var</span> el = els[i];
      <span class="keyword">if</span> (el.CodeMirror) {
        result.push(el);
      }
    }
    <span class="keyword">return</span> $(result);
  };

  CodeMirrorEditor.tracked = <span class="function"><span class="keyword">function</span> <span class="params">(el)</span> {</span>
    el = $(el)[<span class="number">0</span>];
    <span class="keyword">while</span> (el) {
      <span class="keyword">if</span> (el.CodeMirror) {
        <span class="keyword">return</span> <span class="literal">true</span>;
      }
      el = el.parentNode;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  };

  TogetherJS.addTracker(CodeMirrorEditor, <span class="literal">true</span> <span class="comment">/* skip setInit */</span>);

  <span class="function"><span class="keyword">function</span> <span class="title">buildTrackers</span><span class="params">()</span> {</span>
    assert(! liveTrackers.length);
    util.forEachAttr(editTrackers, <span class="function"><span class="keyword">function</span> <span class="params">(TrackerClass)</span> {</span>
      <span class="keyword">var</span> els = TrackerClass.scan();
      $.each(els, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        liveTrackers.push(<span class="keyword">new</span> TrackerClass(<span class="keyword">this</span>));
      });
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">destroyTrackers</span><span class="params">()</span> {</span>
    liveTrackers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(tracker)</span> {</span>
      tracker.destroy();
    });
    liveTrackers = [];
  }

  <span class="function"><span class="keyword">function</span> <span class="title">elementTracked</span><span class="params">(el)</span> {</span>
    <span class="keyword">var</span> result = <span class="literal">false</span>;
    util.forEachAttr(editTrackers, <span class="function"><span class="keyword">function</span> <span class="params">(TrackerClass)</span> {</span>
      <span class="keyword">if</span> (TrackerClass.tracked(el)) {
        result = <span class="literal">true</span>;
      }
    });
    <span class="keyword">return</span> result;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">getTracker</span><span class="params">(el, name)</span> {</span>
    el = $(el)[<span class="number">0</span>];
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;liveTrackers.length; i++) {
      <span class="keyword">var</span> tracker = liveTrackers[i];
      <span class="keyword">if</span> (tracker.tracked(el)) {
        assert((! name) || name == tracker.trackerName, <span class="string">"Expected to map to a tracker type"</span>, name, <span class="string">"but got"</span>, tracker.trackerName);
        <span class="keyword">return</span> tracker;
      }
    }
    <span class="keyword">return</span> <span class="literal">null</span>;
  }

  <span class="keyword">var</span> TEXT_TYPES = (
    <span class="string">"color date datetime datetime-local email "</span> +
        <span class="string">"tel text time week"</span>).split(<span class="regexp">/ /g</span>);

  <span class="function"><span class="keyword">function</span> <span class="title">isText</span><span class="params">(el)</span> {</span>
    el = $(el);
    <span class="keyword">var</span> tag = el.prop(<span class="string">"tagName"</span>);
    <span class="keyword">var</span> type = (el.prop(<span class="string">"type"</span>) || <span class="string">"text"</span>).toLowerCase();
    <span class="keyword">if</span> (tag == <span class="string">"TEXTAREA"</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">if</span> (tag == <span class="string">"INPUT"</span> &amp;&amp; TEXT_TYPES.indexOf(type) != -<span class="number">1</span>) {
      <span class="keyword">return</span> <span class="literal">true</span>;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(el)</span> {</span>
    el = $(el);
    <span class="keyword">if</span> (isCheckable(el)) {
      <span class="keyword">return</span> el.prop(<span class="string">"checked"</span>);
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> el.val();
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">setValue</span><span class="params">(el, value)</span> {</span>
    el = $(el);
    <span class="keyword">if</span> (isCheckable(el)) {
      el.prop(<span class="string">"checked"</span>, value);
    } <span class="keyword">else</span> {
      el.val(value);
    }
    eventMaker.fireChange(el);
  }

  <span class="comment">/* Send the top of this history queue, if it hasn't been already sent. */</span>
  <span class="function"><span class="keyword">function</span> <span class="title">maybeSendUpdate</span><span class="params">(element, history)</span> {</span>
    <span class="keyword">var</span> change = history.getNextToSend();
    <span class="keyword">if</span> (! change) {
      <span class="comment">/* nothing to send */</span>
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> msg = {
      type: <span class="string">"form-update"</span>,
      element: element,
      <span class="string">"server-echo"</span>: <span class="literal">true</span>,
      replace: {
        id: change.id,
        basis: change.basis,
        delta: {
          start: change.delta.start,
          del: change.delta.del,
          text: change.delta.text
        }
      }
    };
    session.send(msg);
  }

  session.hub.on(<span class="string">"form-update"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (! msg.sameUrl) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> el = $(elementFinder.findElement(msg.element));
    <span class="keyword">if</span> (msg.tracker) {
      <span class="keyword">var</span> tracker = getTracker(el, msg.tracker);
      assert(tracker);
      inRemoteUpdate = <span class="literal">true</span>;
      <span class="keyword">try</span> {
        tracker.update(msg);
      } <span class="keyword">finally</span> {
        inRemoteUpdate = <span class="literal">false</span>;
      }
      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> text = isText(el);
    <span class="keyword">var</span> selection;
    <span class="keyword">if</span> (text) {
      selection = [el[<span class="number">0</span>].selectionStart, el[<span class="number">0</span>].selectionEnd];
    }
    <span class="keyword">var</span> value;
    <span class="keyword">if</span> (msg.replace) {
      <span class="keyword">var</span> history = el.data(<span class="string">"togetherjsHistory"</span>);
      <span class="keyword">if</span> (!history) {
        console.warn(<span class="string">"form update received for uninitialized form element"</span>);
        <span class="keyword">return</span>;
      }
      history.setSelection(selection);</pre></div></div>
              
            </li>
          
            <li id="section-7">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-7">&#182;</a>
                </div>
                <p>make a real TextReplace object.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      msg.replace.delta = ot.TextReplace(msg.replace.delta.start,
                                         msg.replace.delta.del,
                                         msg.replace.delta.text);</pre></div></div>
              
            </li>
          
            <li id="section-8">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-8">&#182;</a>
                </div>
                <p>apply this change to the history</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> changed = history.commit(msg.replace);
      maybeSendUpdate(msg.element, history);
      <span class="keyword">if</span> (! changed) {
        <span class="keyword">return</span>;
      }
      value = history.current;
      selection = history.getSelection();
    } <span class="keyword">else</span> {
      value = msg.value;
    }
    inRemoteUpdate = <span class="literal">true</span>;
    <span class="keyword">try</span> {
      setValue(el, value);
      <span class="keyword">if</span> (text) {
        el[<span class="number">0</span>].selectionStart = selection[<span class="number">0</span>];
        el[<span class="number">0</span>].selectionEnd = selection[<span class="number">1</span>];
      }
    } <span class="keyword">finally</span> {
      inRemoteUpdate = <span class="literal">false</span>;
    }
  });

  <span class="keyword">var</span> initSent = <span class="literal">false</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">sendInit</span><span class="params">()</span> {</span>
    initSent = <span class="literal">true</span>;
    <span class="keyword">var</span> msg = {
      type: <span class="string">"form-init"</span>,
      pageAge: Date.now() - TogetherJS.pageLoaded,
      updates: []
    };
    <span class="keyword">var</span> els = $(<span class="string">"textarea, input, select"</span>);
    els.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (elementFinder.ignoreElement(<span class="keyword">this</span>) || elementTracked(<span class="keyword">this</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> el = $(<span class="keyword">this</span>);
      <span class="keyword">var</span> value = getValue(el);
      <span class="keyword">var</span> upd = {
        element: elementFinder.elementLocation(<span class="keyword">this</span>),
        value: value
      };
      <span class="keyword">if</span> (isText(el)) {
        <span class="keyword">var</span> history = el.data(<span class="string">"togetherjsHistory"</span>);
        <span class="keyword">if</span> (history) {
          upd.value = history.committed;
          upd.basis = history.basis;
        }
      }
      msg.updates.push(upd);
    });
    liveTrackers.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(tracker)</span> {</span>
      <span class="keyword">var</span> init = tracker.makeInit();
      assert(tracker.tracked(elementFinder.findElement(init.element)));
      msg.updates.push(init);
    });
    <span class="keyword">if</span> (msg.updates.length) {
      session.send(msg);
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">setInit</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> els = $(<span class="string">"textarea, input, select"</span>);
    els.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">if</span> (elementTracked(<span class="keyword">this</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (elementFinder.ignoreElement(<span class="keyword">this</span>)) {
        <span class="keyword">return</span>;
      }
      <span class="keyword">var</span> el = $(<span class="keyword">this</span>);
      <span class="keyword">var</span> value = getValue(el);
      el.data(<span class="string">"togetherjsHistory"</span>, ot.SimpleHistory(session.clientId, value, <span class="number">1</span>));
    });
    destroyTrackers();
    buildTrackers();
  }

  session.on(<span class="string">"reinitialize"</span>, setInit);

  session.on(<span class="string">"ui-ready"</span>, setInit);

  session.on(<span class="string">"close"</span>, destroyTrackers);

  session.hub.on(<span class="string">"form-init"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (! msg.sameUrl) {
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (initSent) {</pre></div></div>
              
            </li>
          
            <li id="section-9">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-9">&#182;</a>
                </div>
                <p>In a 3+-peer situation more than one client may init; in this case
we&#39;re probably the other peer, and not the peer that needs the init
A quick check to see if we should init...</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> myAge = Date.now() - TogetherJS.pageLoaded;
      <span class="keyword">if</span> (msg.pageAge &lt; myAge) {</pre></div></div>
              
            </li>
          
            <li id="section-10">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-10">&#182;</a>
                </div>
                <p>We&#39;ve been around longer than the other person...</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span>;
      }
    }</pre></div></div>
              
            </li>
          
            <li id="section-11">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-11">&#182;</a>
                </div>
                <p>FIXME: need to figure out when to ignore inits</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    msg.updates.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(update)</span> {</span>
      <span class="keyword">var</span> el;
      <span class="keyword">try</span> {
        el = elementFinder.findElement(update.element);
      } <span class="keyword">catch</span> (e) {
        <span class="comment">/* skip missing element */</span>
        console.warn(e);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (update.tracker) {
        <span class="keyword">var</span> tracker = getTracker(el, update.tracker);
        assert(tracker);
        inRemoteUpdate = <span class="literal">true</span>;
        <span class="keyword">try</span> {
          tracker.init(update, msg);
        } <span class="keyword">finally</span> {
          inRemoteUpdate = <span class="literal">false</span>;
        }
      } <span class="keyword">else</span> {
        inRemoteUpdate = <span class="literal">true</span>;
        <span class="keyword">try</span> {
          setValue(el, update.value);
          <span class="keyword">if</span> (update.basis) {
            <span class="keyword">var</span> history = $(el).data(<span class="string">"togetherjsHistory"</span>);</pre></div></div>
              
            </li>
          
            <li id="section-12">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-12">&#182;</a>
                </div>
                <p>don&#39;t overwrite history if we&#39;re already up to date
(we might have outstanding queued changes we don&#39;t want to lose)</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!(history &amp;&amp; history.basis === update.basis &amp;&amp;</pre></div></div>
              
            </li>
          
            <li id="section-13">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-13">&#182;</a>
                </div>
                <p>if history.basis is 1, the form could have lingering
edits from before togetherjs was launched.  that&#39;s too bad,
we need to erase them to resynchronize with the peer
we just asked to join.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>                  history.basis !== <span class="number">1</span>)) {
              $(el).data(<span class="string">"togetherjsHistory"</span>, ot.SimpleHistory(session.clientId, update.value, update.basis));
            }
          }
        } <span class="keyword">finally</span> {
          inRemoteUpdate = <span class="literal">false</span>;
        }
      }
    });
  });

  <span class="keyword">var</span> lastFocus = <span class="literal">null</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">focus</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> target = event.target;
    <span class="keyword">if</span> (elementFinder.ignoreElement(target)) {
      blur(event);
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (target != lastFocus) {
      lastFocus = target;
      session.send({type: <span class="string">"form-focus"</span>, element: elementFinder.elementLocation(target)});
    }
  }

  <span class="function"><span class="keyword">function</span> <span class="title">blur</span><span class="params">(event)</span> {</span>
    <span class="keyword">var</span> target = event.target;
    <span class="keyword">if</span> (lastFocus) {
      lastFocus = <span class="literal">null</span>;
      session.send({type: <span class="string">"form-focus"</span>, element: <span class="literal">null</span>});
    }
  }

  <span class="keyword">var</span> focusElements = {};

  session.hub.on(<span class="string">"form-focus"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">var</span> current = focusElements[msg.peer.id];
    <span class="keyword">if</span> (current) {
      current.remove();
      current = <span class="literal">null</span>;
    }
    <span class="keyword">if</span> (! msg.element) {</pre></div></div>
              
            </li>
          
            <li id="section-14">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-14">&#182;</a>
                </div>
                <p>A blur</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> element = elementFinder.findElement(msg.element);
    focusElements[msg.peer.id] = createFocusElement(msg.peer, element);
  });

  session.hub.on(<span class="string">"hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (lastFocus) {
      setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">if</span> (lastFocus) {
          session.send({type: <span class="string">"form-focus"</span>, element: elementFinder.elementLocation(lastFocus)});
        }
      });
    }
  });

  <span class="function"><span class="keyword">function</span> <span class="title">createFocusElement</span><span class="params">(peer, around)</span> {</span>
    around = $(around);
    <span class="keyword">var</span> el = templating.sub(<span class="string">"focus"</span>, {peer: peer});
    el = el.find(<span class="string">".togetherjs-focus"</span>);
    <span class="keyword">var</span> aroundOffset = around.offset();
    el.css({
      top: aroundOffset.top-FOCUS_BUFFER + <span class="string">"px"</span>,
      left: aroundOffset.left-FOCUS_BUFFER + <span class="string">"px"</span>,
      width: around.outerWidth() + (FOCUS_BUFFER*<span class="number">2</span>) + <span class="string">"px"</span>,
      height: around.outerHeight() + (FOCUS_BUFFER*<span class="number">2</span>) + <span class="string">"px"</span>
    });
    $(document.body).append(el);
    <span class="keyword">return</span> el;
  }

  session.on(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(document).on(<span class="string">"change"</span>, change);</pre></div></div>
              
            </li>
          
            <li id="section-15">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-15">&#182;</a>
                </div>
                <p>note that textInput, keydown, and keypress aren&#39;t appropriate events
to watch, since they fire <em>before</em> the element&#39;s value changes.</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    $(document).on(<span class="string">"input keyup cut paste"</span>, maybeChange);
    $(document).on(<span class="string">"focusin"</span>, focus);
    $(document).on(<span class="string">"focusout"</span>, blur);
  });

  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(document).off(<span class="string">"change"</span>, change);
    $(document).off(<span class="string">"input keyup cut paste"</span>, maybeChange);
    $(document).off(<span class="string">"focusin"</span>, focus);
    $(document).off(<span class="string">"focusout"</span>, blur);
  });

  session.hub.on(<span class="string">"hello"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.sameUrl) {
      setTimeout(sendInit);
    }
  });

  <span class="keyword">return</span> forms;
});</pre></div></div>
              
            </li>
          
        </ul>
      </div>
    </section>






        <hr>

        <footer>

          <section class="row" id="footer">
            <div class="col-xs-3 text-left">
              <p><a href="https://mozillalabs.com/en-US/" target="_blank"><img src="../images/footer-mozilla-labs.png"></a></p>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href=".././" class="scrollnav">Overview</a></li>
                <li><a href=".././docs/" target="_blank">Docs</a></li>
                <li class=""><a href="https://github.com/mozilla/togetherjs" target="_blank">Github</a></li>
                <li class=""><a href="mailto:togetherjs@mozilla.com" target="_blank">Contact</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://mozillalabs.com/en-US/togetherjs/" target="_blank">About</a></li>
                <li><a href=".././docs/contributing.html">Contributing</a></li>
                <li><a href="../source/">Source Code</a></li>
                <li><a href="../faq.html">FAQ</a></li>
                <li class=""><a href="https://twitter.com/togetherjs" target="_blank">Twitter</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://www.mozilla.org/en-US/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/about/legal.html" target="_blank">Legal Notices</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/legal/fraud-report/index.html" target="_blank">Report Trademark Abuses</a></li>
              </ul>
            </div>
          </section>
        </footer>
      </section>

    </div> <!-- /container -->

  </body>
</html>
